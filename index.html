<!DOCTYPE html>
<html>
    <body>
        <canvas id="canvas"></canvas>
    </body>
    <script type="text/javascript">
     var N = 20;
     var canvas = document.querySelector('canvas');
     var ctx = canvas.getContext('2d');
     canvas.width = document.documentElement.clientWidth;
     canvas.height = document.documentElement.clientHeight;

     //随机数函数
     function random(min,max) {
         return parseInt(Math.random()*(max - min) + min);
     }

     //构造函数
     function Ball(id, x, y, r, speedX, speedY) {
         this.id = id;
         this.img = new Image();
         this.img.src = "./image/" + id + ".png";
         this.r = r || 60;
         this.x = x || random(this.r, canvas.width - this.r);
         this.y = y || random(this.r, canvas.height - this.r);
         this.speedX = speedX || random(1, 5);
         this.speedY = speedY || random(1, 5);
         this.c = 9;
         this.alive = 1;
         //draw方法
         this.reset = function(){
             this.r = r || 60;
             this.x = x || random(this.r, canvas.width - this.r);
             this.y = y || random(this.r, canvas.height - this.r);
             this.speedX = speedX || random(1, 5);
             this.speedY = speedY || random(1, 5);
             this.c = 9;
             this.alive = 1;
         }         
         this.draw = function() {
             if(!this.alive)return;            
             ctx.beginPath();
             ctx.font = "60px Arial";
             ctx.save();             
             ctx.arc(this.x, this.y, this.r, 0, Math.PI*2, true);
             ctx.clip();
             ctx.drawImage(this.img, this.x - this.r, this.y - this.r, 120, 120);//, this.x + this.r, this.y + this.r);
             ctx.restore();
             ctx.save();
             if(this.c > 2)ctx.fillStyle = "grey";
             else ctx.fillStyle = "red";
             if(this.c <= 5)
                 ctx.fillText(this.c , this.x - 16, this.y + 20);
             ctx.restore();
         }
         //move方法
         this.move = function() {
             this.x += this.speedX;
             this.y += this.speedY;
             if(this.x < this.r || this.x > canvas.width  - this.r) {
                 if(this.x < this.r)this.x = this.r;
                 else this.x = canvas.width - this.r;
                 this.speedX = -this.speedX;
             }
             if(this.y < this.r || this.y > canvas.height - this.r) {
                 if(this.y < this.r)this.y = this.r;
                 else this.y = canvas.height - this.r;
                 this.speedY = -this.speedY;
             }
             this.draw();//调用draw方法
         }
     }

     for(var i = 0; i < N; i++){
         eval("ball" + i + " = new Ball(" + i + ")");
         eval("ball" + i + ".draw()");
     }
     // 碰撞函数
     function solve(obj1, obj2){
         if(obj1.id == 0){
             obj2.c++;
         }
         else {
             obj1.c--;
             obj2.c--;
         }
         if(obj1.c == 0)obj1.alive = 0;
         if(obj2.c == 0)obj2.alive = 0;
     }
     function Col(a, b){
         var ax = a.speedX, ay = a.speedY;
         var bx = b.speedX, by = b.speedY;
         var A = Math.atan((b.y - a.y) / (b.x - a.x));
         var sin = Math.sin(A), cos = Math.cos(A);
         var av = cos * ax + sin * ay;
         var bv = cos * bx + sin * by;
         ax = ax * sin * sin + bv * cos;
         bx = bx * sin * sin + av * cos;
         ay = ay * cos * cos + bv * sin;
         by = by * cos * cos + av * sin;
         a.speedX = ax; a.speedY = ay;
         b.speedX = bx; b.speedY = by;
     }
     function isCrash(obj1, obj2) {
         var x = obj1.x - obj2.x;
         var y = obj1.y - obj2.y;
         var distance = Math.sqrt(x*x + y*y);//开方函数
         if(distance < obj1.r + obj2.r) {//判断碰撞
             solve(obj1, obj2);
             var p = (obj1.r + obj2.r - distance) / 2;
             var dx = obj1.x - obj2.x;
             var dy = obj1.y - obj2.y;
             var T = p / Math.sqrt(dx * dx + dy * dy);

             obj1.x += dx * T;
             obj1.y += dy * T;
             obj2.x += -dx * T;
             obj2.y += -dy * T;
             Col(obj1, obj2);
         }
     }

     var frameNum = 0;
     var prevDate = new Date();

     function gameloop() {
         frameNum++;
         ctx.clearRect(0, 0, canvas.width, canvas.height);
         canvas.width = document.documentElement.clientWidth;
         canvas.height = document.documentElement.clientHeight;
         for(var i = 0; i < N; i++)
             eval("ball" + i + ".move()");
         for(var i = 0; i < N; i++)
             for(var j = i + 1; j < N; j++)
                 if(eval("ball" + i + ".alive && ball" + j + ".alive"))
                     eval("isCrash(" + "ball" + i + ", ball" + j + ")");
         if(frameNum % 50 == 0)
             for(var i = 0; i < N; i++)
                 if(eval("!ball" + i + ".alive")){
                     eval("ball" + i + ".reset()");
                     break;
                 }
         window.requestAnimationFrame(gameloop);
     }
     gameloop();
    </script>
</html>
